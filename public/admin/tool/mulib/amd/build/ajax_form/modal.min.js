define("tool_mulib/ajax_form/modal",["exports","jquery","core/modal","core/fragment","core/notification","core_form/events","core_form/changechecker","core/pending"],(function(_exports,_jquery,_modal,_fragment,Notification,FormEvents,FormChangeChecker,_pending){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_modal=_interopRequireDefault(_modal),_fragment=_interopRequireDefault(_fragment),Notification=_interopRequireWildcard(Notification),FormEvents=_interopRequireWildcard(FormEvents),FormChangeChecker=_interopRequireWildcard(FormChangeChecker),_pending=_interopRequireDefault(_pending);const STATUSES_CANCELLED="cancelled",STATUSES_RENDER="render",STATUSES_SUBMITTED="submitted",ACTIONS_REDIRECT="redirect",ACTIONS_RELOAD="reload";class AjaxFormModal extends _modal.default{constructor(root){super(root),this.reloadingForm=!1,this.formUrl=null,this.formSubmittedAction=null}configure(modalConfig){this.formUrl=modalConfig.formUrl,this.formSubmittedAction=modalConfig.formSubmittedAction,modalConfig.show=!1,modalConfig.removeOnClose=!0,super.configure(modalConfig),"lg"!==modalConfig.formSize&&"xl"!==modalConfig.formSize||this.getModal().addClass("modal-".concat(modalConfig.formSize)),this.show()}registerEventListeners(){super.registerEventListeners(),this.getBody().on("click","form input[type=submit]",(e=>{this.submitAjaxForm(e)})),this.getRoot().on("submit","form",(e=>{this.submitAjaxForm.bind(e)}))}getForm(){return this.getRoot().find("form")[0]}validateElements(){FormEvents.notifyFormSubmittedByJavascript(this.getForm());const invalid=this.getRoot().find('[aria-invalid="true"], .error');return!invalid.length||(invalid.first().focus(),!1)}submitAjaxForm(e){if(e.preventDefault(),"1"===e.target.dataset.cancel)return FormChangeChecker.resetAllFormDirtyStates(),void this.destroy();if("1"!==e.target.dataset.skipValidation&&!this.validateElements())return;let formData=this.getRoot().find("form").serialize();"submit"===e.target.type&&(formData=formData+"&"+encodeURIComponent(e.target.name)+"="+encodeURIComponent(e.target.value)),FormChangeChecker.resetAllFormDirtyStates(),this.reloadForm(formData)}reloadForm(formData){if(this.reloadingForm)return;this.reloadingForm=!0;const pendingPromise=new _pending.default("tool_mulib/modal_ajax_form:reload");this.disableSubmitButtons();const settings={async:!0,data:formData,dataType:"json",processData:!1,timeout:0,type:"POST"},renderPromise=_jquery.default.Deferred();""===formData?this.setBody(renderPromise.promise()):this.startSubmitting(),_jquery.default.ajax(this.formUrl,settings).done((response=>{var _response$data;if(!response)throw new Error("Invalid server response");if(response.error)Notification.exception(response);else if(null!==(_response$data=response.data)&&void 0!==_response$data&&_response$data.status)if(response.data.status===STATUSES_RENDER)""!==formData&&this.setBody(renderPromise.promise()),renderPromise.resolve(response.data.html,_fragment.default.processCollectedJavascript(response.data.javascript)),""!==response.data.dialogtitle&&this.setTitle(response.data.dialogtitle),this.enableSubmitButtons();else if(response.data.status===STATUSES_CANCELLED)this.destroy();else if(response.data.status===STATUSES_SUBMITTED)if(renderPromise.resolve("",""),"function"==typeof this.formSubmittedAction){const callback=this.formSubmittedAction;this.destroy(),callback(response.data.callbackdata)}else this.formSubmittedAction===ACTIONS_RELOAD?(FormChangeChecker.disableAllChecks(),window.location.reload()):this.formSubmittedAction===ACTIONS_REDIRECT?(FormChangeChecker.disableAllChecks(),window.location=response.data.redirecturl):this.destroy();else Notification.exception(new Error("Invalid form data.status value received"));else Notification.exception(new Error("Invalid server response"))})).catch((ex=>{Notification.exception(ex)})).always((()=>{pendingPromise.resolve(),this.finishSubmitting(),this.reloadingForm=!1}))}disableSubmitButtons(){this.getBody().find("form input[type=submit]").prop("disabled",!0)}enableSubmitButtons(){this.getBody().find("form input[type=submit]").prop("disabled",!1)}startSubmitting(){this.getBody().find('[data-region="submitting-icon-container"]').removeClass("hidden")}finishSubmitting(){this.getBody().find('[data-region="submitting-icon-container"]').addClass("hidden")}show(){return this.reloadForm(""),super.show()}hide(){const form=this.getForm();FormEvents.notifyFormSubmittedByJavascript(form,!0),FormChangeChecker.resetFormDirtyState(form),super.hide()}}return _exports.default=AjaxFormModal,_defineProperty(AjaxFormModal,"TYPE","tool_mulib-ajax_form_modal"),_defineProperty(AjaxFormModal,"TEMPLATE","tool_mulib/ajax_form/modal"),AjaxFormModal.registerModalType(),_exports.default}));

//# sourceMappingURL=modal.min.js.map