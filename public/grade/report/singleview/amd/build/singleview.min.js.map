{"version":3,"file":"singleview.min.js","sources":["../src/singleview.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Allow navigation through table cells using Ctrl + arrow keys and handle override toggles.\n *\n * @module    gradereport_singleview/singleview\n * @copyright The Open University\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nconst selectors = {\n    cell: 'td.cell, th.cell',\n    col: 'td, th',\n    keyboardHandled: 'table input, table select, table a',\n    navigableCell: 'input:not([type=\"hidden\"]):not([disabled]), select, a',\n    override: 'input[name^=override_]',\n    row: 'tr',\n    // Dyanmic selectors.\n    input: (interest) => `input[name$='${interest}'][data-uielement='text']`,\n    select: (interest) => `select[name$='${interest}']`,\n};\n\nlet initialized = false;\n\n/**\n * Initializes the module, setting up event listeners for table cell navigation and override toggles.\n */\nexport function init() {\n    if (initialized) {\n        return;\n    }\n    initialized = true;\n\n    // Add ctrl+arrow controls for navigation.\n    // Use capturing phase to intercept events before they reach anchor elements.\n    document.addEventListener('keydown', keydownHandler, true);\n\n    // Handle override toggles.\n    document.querySelectorAll(selectors.override).forEach(input => {\n        input.addEventListener('change', () => {\n            updateOverrideToggle(input);\n        });\n    });\n}\n\n/**\n * Handles control+arrow table navigation.\n *\n * @private\n * @param {KeyboardEvent} event The keydown event.\n */\nfunction keydownHandler(event) {\n    if (!event.ctrlKey) {\n        return;\n    }\n\n    // Check if it's an arrow key.\n    if (!['ArrowLeft', 'ArrowUp', 'ArrowRight', 'ArrowDown'].includes(event.key)) {\n        return;\n    }\n\n    const activeElement = document.activeElement;\n    if (!activeElement.matches(selectors.keyboardHandled)) {\n        return;\n    }\n\n    let next = null;\n    switch (event.key) {\n        case 'ArrowLeft':\n            next = getPrevCell(activeElement.closest(selectors.col));\n            break;\n        case 'ArrowUp':\n            next = getAboveCell(activeElement.closest(selectors.col));\n            break;\n        case 'ArrowRight':\n            next = getNextCell(activeElement.closest(selectors.col));\n            break;\n        case 'ArrowDown':\n            next = getBelowCell(activeElement.closest(selectors.col));\n            break;\n    }\n\n    // Immediately prevent default behavior and stop propagation.\n    event.preventDefault();\n    event.stopImmediatePropagation();\n\n    if (next) {\n        next.querySelector(selectors.navigableCell)?.focus();\n    }\n}\n\n/**\n * Handles changes to override toggles.\n *\n * @private\n * @param {HTMLInputElement} input The override toggle input element.\n */\nfunction updateOverrideToggle(input) {\n    const checked = input.checked;\n    const [, itemid, userid] = input.getAttribute('name').split('_');\n    const interest = `_${itemid}_${userid}`;\n\n    // Handle text inputs.\n    document.querySelectorAll(selectors.input(interest)).forEach(\n        text => {\n            text.disabled = !checked;\n        }\n    );\n\n    // Handle select elements.\n    document.querySelectorAll(selectors.select(interest)).forEach(\n        select => {\n            select.disabled = !checked;\n        }\n    );\n}\n\n/**\n * Helper function to get the next cell in the table.\n *\n * @private\n * @param {HTMLElement} cell The cell of the table.\n * @returns {HTMLElement|null} The next navigable cell or null if none found.\n */\nfunction getNextCell(cell) {\n    const checkElement = cell || document.activeElement;\n    const next = checkElement.nextElementSibling?.matches(selectors.cell) ? checkElement.nextElementSibling : null;\n    if (!next) {\n        return null;\n    }\n    // Continue until we find a navigable cell.\n    if (!next.querySelector(selectors.navigableCell)) {\n        return getNextCell(next);\n    }\n\n    return next;\n}\n\n/**\n * Helper function to get the previous cell in the table.\n *\n * @private\n * @param {HTMLElement} cell The cell of the table.\n */\nfunction getPrevCell(cell) {\n    const checkElement = cell || document.activeElement;\n    const prev = checkElement.previousElementSibling?.matches(selectors.cell) ? checkElement.previousElementSibling : null;\n    if (!prev) {\n        return null;\n    }\n    // Continue until we find a navigable cell.\n    if (!prev.querySelector(selectors.navigableCell)) {\n        return getPrevCell(prev);\n    }\n\n    return prev;\n}\n\n/**\n * Helper function to get the cell above the current cell in the table.\n *\n * @private\n * @param {HTMLElement} cell The current table cell element.\n * @returns {HTMLElement|null} The cell above or null if none found.\n */\nfunction getAboveCell(cell) {\n    const checkElement = cell || document.activeElement;\n    const tr = checkElement.closest(selectors.row).previousElementSibling;\n    const columnIndex = getColumnIndex(checkElement);\n    if (!tr) {\n        return null;\n    }\n    const next = tr.querySelectorAll(selectors.col)[columnIndex];\n    // Continue until we find a navigable cell.\n    if (!next?.querySelector(selectors.navigableCell)) {\n        return getAboveCell(next);\n    }\n\n    return next;\n}\n\n/**\n * Helper function to get the cell below the current cell in the table.\n *\n * @private\n * @param {HTMLElement} cell The current table cell element.\n * @returns {HTMLElement|null} The cell below or null if none found.\n */\nfunction getBelowCell(cell) {\n    const checkElement = cell || document.activeElement;\n    const tr = checkElement.closest('tr').nextElementSibling;\n    const columnIndex = getColumnIndex(checkElement);\n    if (!tr) {\n        return null;\n    }\n    const next = tr.querySelectorAll('td, th')[columnIndex];\n    // Continue until we find a navigable cell.\n    if (!next?.querySelector(selectors.navigableCell)) {\n        return getBelowCell(next);\n    }\n\n    return next;\n}\n\n/**\n * Helper function to get the column index of a cell.\n *\n * @param {HTMLElement} cell The cell of the table.\n * @returns {number} The index of the cell within its row.\n */\nfunction getColumnIndex(cell) {\n    const rowNode = cell.closest(selectors.row);\n    if (!rowNode || !cell) {\n        return -1;\n    }\n    const cells = Array.from(rowNode.querySelectorAll(selectors.col));\n\n    return cells.indexOf(cell);\n}\n"],"names":["initialized","document","addEventListener","keydownHandler","querySelectorAll","selectors","forEach","input","checked","itemid","userid","getAttribute","split","interest","text","disabled","select","updateOverrideToggle","event","ctrlKey","includes","key","activeElement","matches","next","getPrevCell","closest","getAboveCell","getNextCell","getBelowCell","preventDefault","stopImmediatePropagation","querySelector","focus","cell","checkElement","nextElementSibling","prev","previousElementSibling","tr","columnIndex","getColumnIndex","rowNode","Array","from","indexOf"],"mappings":"+JAyCQA,mBAGJA,aAAc,EAIdC,SAASC,iBAAiB,UAAWC,gBAAgB,GAGrDF,SAASG,iBAAiBC,oBAAoBC,SAAQC,QAClDA,MAAML,iBAAiB,UAAU,eA0DXK,aACpBC,QAAUD,MAAMC,UACbC,OAAQC,QAAUH,MAAMI,aAAa,QAAQC,MAAM,KACtDC,oBAAeJ,mBAAUC,QAG/BT,SAASG,iBAAiBC,gBAAgBQ,WAAWP,SACjDQ,OACIA,KAAKC,UAAYP,WAKzBP,SAASG,iBAAiBC,iBAAiBQ,WAAWP,SAClDU,SACIA,OAAOD,UAAYP,WAxEnBS,CAAqBV;;;;;;;;MA9B3BF,eACI,mBADJA,cAEG,SAFHA,0BAGe,qCAHfA,wBAIa,wDAJbA,mBAKQ,yBALRA,cAMG,KANHA,gBAQMQ,iCAA6BA,sCARnCR,iBASOQ,kCAA8BA,mBAGvCb,aAAc,WA6BTG,eAAee,WACfA,MAAMC,mBAKN,CAAC,YAAa,UAAW,aAAc,aAAaC,SAASF,MAAMG,kBAIlEC,cAAgBrB,SAASqB,kBAC1BA,cAAcC,QAAQlB,sCAIvBmB,KAAO,YACHN,MAAMG,SACL,YACDG,KAAOC,YAAYH,cAAcI,QAAQrB,0BAExC,UACDmB,KAAOG,aAAaL,cAAcI,QAAQrB,0BAEzC,aACDmB,KAAOI,YAAYN,cAAcI,QAAQrB,0BAExC,YACDmB,KAAOK,aAAaP,cAAcI,QAAQrB,yCAKlDa,MAAMY,iBACNZ,MAAMa,2BAEFP,oCACAA,KAAKQ,cAAc3B,6EAA0B4B,kBAqC5CL,YAAYM,sCACXC,aAAeD,MAAQjC,SAASqB,cAChCE,mCAAOW,aAAaC,2EAAoBb,QAAQlB,gBAAkB8B,aAAaC,mBAAqB,YACrGZ,KAIAA,KAAKQ,cAAc3B,yBAIjBmB,KAHII,YAAYJ,MAJZ,cAgBNC,YAAYS,sCACXC,aAAeD,MAAQjC,SAASqB,cAChCe,mCAAOF,aAAaG,+EAAwBf,QAAQlB,gBAAkB8B,aAAaG,uBAAyB,YAC7GD,KAIAA,KAAKL,cAAc3B,yBAIjBgC,KAHIZ,YAAYY,MAJZ,cAiBNV,aAAaO,YACZC,aAAeD,MAAQjC,SAASqB,cAChCiB,GAAKJ,aAAaT,QAAQrB,eAAeiC,uBACzCE,YAAcC,eAAeN,kBAC9BI,UACM,WAELf,KAAOe,GAAGnC,iBAAiBC,eAAemC,oBAE3ChB,MAAAA,MAAAA,KAAMQ,cAAc3B,yBAIlBmB,KAHIG,aAAaH,eAanBK,aAAaK,YACZC,aAAeD,MAAQjC,SAASqB,cAChCiB,GAAKJ,aAAaT,QAAQ,MAAMU,mBAChCI,YAAcC,eAAeN,kBAC9BI,UACM,WAELf,KAAOe,GAAGnC,iBAAiB,UAAUoC,oBAEtChB,MAAAA,MAAAA,KAAMQ,cAAc3B,yBAIlBmB,KAHIK,aAAaL,eAYnBiB,eAAeP,YACdQ,QAAUR,KAAKR,QAAQrB,mBACxBqC,UAAYR,YACL,SAEES,MAAMC,KAAKF,QAAQtC,iBAAiBC,gBAErCwC,QAAQX"}