define(["jquery"], function ($) {
  var transport = function (selector, query, callback, failure) {
    $.get({
      url: M.cfg.wwwroot + "/local/residencebooking/ajax/guest_search.php",
      data: { term: query || "" },
      dataType: "json",
    })
      .done(function (response) {
        if (response && response.results) {
          callback(response.results);
        } else {
          callback([]);
        }
      })
      .fail(function (jqXHR, textStatus, errorThrown) {
        failure(textStatus + ": " + errorThrown);
      });
  };
  var processResults = function (selector, results) {
    var processedResults = [];
    if (Array.isArray(results)) {
      results.forEach(function (item) {
        processedResults.push({ 
          value: item.id, 
          label: item.text,
          pf_number: item.pf_number
        });
      });
    }
    return processedResults;
  };
  var initAutocomplete = function(guestSelector, serviceNumberSelector) {
    $(document).ready(function() {
      var guestField = $(guestSelector);
      var serviceNumberField = $(serviceNumberSelector);
      
      if (guestField.length === 0) {
        guestField = $('input[name="guest_name"]');
        if (guestField.length === 0) {
          return;
        }
      }
      
      if (serviceNumberField.length === 0) {
        serviceNumberField = $('input[name="service_number"]');
        if (serviceNumberField.length === 0) {
          return;
        }
      }
      
      function extractPFNumber(text) {
        if (!text) return null;
        var pfMatch = text.match(/PF(\d+)/);
        return pfMatch ? 'PF' + pfMatch[1] : null;
      }
      
      function populateServiceNumber(selectedText) {
        var pfNumber = extractPFNumber(selectedText);
        if (pfNumber) {
          serviceNumberField.val(pfNumber);
          return;
        }
        
        $.get({
          url: M.cfg.wwwroot + "/local/residencebooking/ajax/get_pf_number.php",
          data: { guest_name: selectedText },
          dataType: "json"
        })
        .done(function(response) {
          if (response.success && response.pf_number) {
            serviceNumberField.val(response.pf_number);
          }
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
          // Silent fail - user can manually enter PF number
        });
      }
      
      guestField.on('change', function() {
        var selectedGuest = $(this).val();
        
        if (selectedGuest && selectedGuest.trim() !== '') {
          populateServiceNumber(selectedGuest);
        } else {
          serviceNumberField.val('');
        }
      });
      
      guestField.on('select2:select', function(e) {
        var selectedGuest = e.params.data.text || e.params.data.id;
        populateServiceNumber(selectedGuest);
      });
      
      guestField.on('input', function() {
        var selectedGuest = $(this).val();
        if (selectedGuest && selectedGuest.includes('PF')) {
          populateServiceNumber(selectedGuest);
        }
      });
      
      setTimeout(function() {
        var currentValue = guestField.val();
        if (currentValue && currentValue.includes('PF')) {
          populateServiceNumber(currentValue);
        }
      }, 1000);
    });
  };
  return { transport: transport, processResults: processResults, initAutocomplete: initAutocomplete };
});
//# sourceMappingURL=guest_autocomplete.min.js.map
